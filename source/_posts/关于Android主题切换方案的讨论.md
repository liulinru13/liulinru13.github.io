---
title: 关于Android主题切换方案的讨论
tags:
  - Android
  - 主题切换
date: 2016-07-29 23:14:16
categories:
	- Android
---

## 背景

公司这期要求在Android端产品中增加主题切换的功能，因此对于现在Android应用的主题切换方案在网络上进行了搜集，结合实际需求，提出了相应的方案。现对比较流行、常用的方案进行下讨论和记录。

## 市面上比较流行的方案列举

1. 通过在`values`文件夹下的`attrs.xml`和`style.xml`文件中配置不同的风格的主题，在`Activity`中的`onCreate()`方法中，调用`setContentView()`方法前调用`setTheme()`方法来设置主题。
2. 通过将资源文件打包为APK的方式，在代码中对APK进行下载、解包操作，获取其中的相应资源加载到项目中，实现动态的主题切换。
3. 使用压缩包对资源进行压缩，下载到设备SD卡上，利用代码进行解压缩获取内含的资源文件进行使用，理论上可行，类似方案二。
4. 主题样式不使用xml文件定义，代码实现主题样式效果工具类；框架层提供功能方法，`View`及其组件代码设置样式属性，动态加载改变主题。

## 上述方案优缺点的讨论

总结来看就是上述四种，其他无非上述几种方案的相互组合。这四种方案各有优缺点，比较好的方式还是根据实际需求进行取舍，谋求优点的最大化。

###讨论

> 方案一

代码量少，工作量基本在于样式文件的配置，易懂易学也易于实现；
笨重，灵活性较低，不易于扩展。线上应用需要更新才能获取新的主题，适用于“一次性应用”和实验性质的demo。

> 方案二

可以动态的扩展主题，包中资源较少，不需要进行应用的整体更新，很多成熟应用都在用该方案作为主题框架的一部分；
有一定开发难度，需要适配不同机型（尤其是不同厂家的定制ROM），扩展性和灵活性仍然有所欠缺。

> 方案三

可以动态的扩展主题，不需要整体更新；
需要手动配置资源，手写资源读取优化工具类，很少采用。

> 方案四

相对于前三种方案，方案四更加的灵活，具体的实现方式也有很多种（有难有易），举例来说。
1. 第一种，在`Framework`层进行代码修改，便于实现动态部署，客户端的代码量少，apk包小；难度很大，毕竟更加深入，需要丰富的底层知识，出错几率大，例如MIUI的深层定制。
2. 第二种，重写`Resouce`类，可以在类中资源的选择逻辑。相当于把资源选择逻辑做了一次封装，上层代码直接调用`context.getResouce()`方法即可和往常一样使用。但还是有些不够灵活，通常搭配其他方案使用。
3. 第三种，布局初始化过程中，保留`View`的引用，每次更换主题时遍历一遍这些引用，进行颜色、图片等主题资源的重新设置，或者不保留`View`引用，直接递归遍历页面内的所有`View`对象，来进行主题资源的设置。这种方案也是GitHub上很多Android主题切换框架采用的方案（或者是方案的一部分）。实现方案的大概思路是自定义`LayoutInflater.Factory`类设置到`Activity`的`LayoutInflater`对象中去，在解析xml布局时遍历`View`树进行选择性保留。但是这种方案存在缺陷，就是无法对代码中动态的设置产生作用。

##继续讨论

鉴于上面的讨论，可以看出每种方案都不是完美的。需要根据实际情况结合起来进行使用，例如可以通过重写一个封装了资源选择逻辑的`Resource`类与方案四的第三种情况结合使用，在布局实例化时记录一次，在动态设置时（例如调用setTextColor方法）经过`Resource`进行动态的逻辑判断返回合适的资源；

再比如可以将方案二和方案四整合到一个主题切换框架中去，增加框架的扩展性和灵活性。

对于页面比较多的应用来说，在页面栈中留存有不少页面时进行主题切换，如何通知这些留存页面进行主题切换也是一个需要思考的问题，这时可以用观察者模式进行解决。还需要考虑到大量页面进行主题切换的开销可能导致的OOM...等等


